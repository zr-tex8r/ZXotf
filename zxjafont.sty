%
% zxjafont.sty
%
%%%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{zxjafont}[2009/12/12 v1.0]
\RequirePackage{ifxetex}
\RequireXeTeX

%%%% preparation
\def\zxjf@pkgname{zxjafont}
\def\zxjf@error{\PackageError\zxjf@pkgname}
\def\zxjf@warn{\PackageInfo\zxjf@pkgname}
\RequirePackage{fontspec}
\RequirePackage{keyval}
%
\ifx\bxUseDebug\relax \let\zxjf@debug\@gobble
\else \def\zxjf@debug#1{\typeout{\zxjf@pkgname: #1}}
\fi

%%%% options handling
\let\zxjf@scale\relax
\define@key{zxjf}{scale}{\def\zxjf@scale{#1}}
\let\zxjf@feat\@empty
\define@key{zxjf}{feature}{\def\zxjf@feat{#1}}
\let\zxjf@preset\relax
\DeclareOption{ms}{\def\zxjf@preset{ms}}
\DeclareOption{ms-dx}{\def\zxjf@preset{ms-dx}}
\DeclareOption{ipa}{\def\zxjf@preset{ipa}}
\DeclareOption{ipa-dx}{\def\zxjf@preset{ipa-dx}}
\DeclareOption{kozuka}{\def\zxjf@preset{kozuka}}
\DeclareOption{hiragino}{\def\zxjf@preset{hiragino}}
\DeclareOption{hiragino-dx}{\def\zxjf@preset{hiragino-dx}}
\DeclareOption*{\def\zxjf@nxt{\setkeys{zxjf}}%
  \expandafter\zxjf@nxt\expandafter{\CurrentOption}}
\def\zxjf@all@presets{%
  ms, ms-dx, ipa, ipa-dx, kozuka, hiragino, hiragino-dx}
\ProcessOptions*
% preset must be given
\ifx\zxjf@preset\relax
  \zxjf@error{Preset name not specified}
  {You must give one of the following names as option.\MessageBreak
   \space\space\zxjf@all@presets}
  \endinput\fi

%%%% detect bxjatype
\newif\ifzxjf@zxjatype
\@ifpackageloaded{zxjatype}{\zxjf@zxjatypetrue}{}
\AtBeginDocument{%
  \ifzxjf@zxjatype\else\@ifpackageloaded{zxjatype}{%
      \zxjf@error{zxjatype must be loaded before me}\@ehc
  }\fi}

%%%% decide scale factor
\ifx\zxjf@scale\relax
  \ifzxjf@zxjatype \let\zxjf@scale\zxjt@scale
  \else\ifx\jsDocClass\@undefined \def\zxjf@scale{1}%
  \else \let\zxjf@scale\jsScale \fi\fi
\fi
\def\zxjf@xonce#1{\expandafter\unexpanded\expandafter{#1}}
\edef\zxjf@feat{Scale=\zxjf@xonce\zxjf@scale,\zxjf@xonce\zxjf@feat}
\zxjf@debug{\string\zxjf@feat=\zxjf@feat
  /\string\zxjf@preset=\zxjf@preset}

%%-------- preset japanese font mappings

%%%% \zxjf@setmainfont{<attributes>}{<fam_name>}, etc.
\ifzxjf@zxjatype
\def\zxjf@setmainfont#1{\setjamainfont[\zxjf@feat,#1]}
\def\zxjf@setsansfont#1{\setjasansfont[\zxjf@feat,#1]}
\def\zxjf@setmonofont#1{\setjamonofont[\zxjf@feat,#1]}
\def\zxjf@newfamily#1#2{\setjafamilyfont{#1}[\zxjf@feat,#2]}
\else
\def\zxjf@setmainfont#1{\setmainfont[\zxjf@feat,#1]}
\def\zxjf@setsansfont#1{\setsansfont[\zxjf@feat,#1]}
\def\zxjf@setmonofont#1{\setmonofont[\zxjf@feat,#1]}
\def\zxjf@newfamily#1#2{%
  \expandafter\newfontfamily\csname #1family\endcsname[\zxjf@feat,#2]}
\fi

%%%% \zxjf@declare@preset{<name>}{<text>}, etc.
\def\zxjf@declare@preset#1{%
  \expandafter\zxjf@decl@preset@a\csname zxjf@use@preset@#1\endcsname}
\def\zxjf@decl@preset@a#1{\@onlypreamble#1\def#1}
\@onlypreamble\zxjf@uniweight
\def\zxjf@uniweight#1#2{%
  \zxjf@setmainfont{BoldFont=#2}{#1}%
  \zxjf@setsansfont{}{#2}%
  \zxjf@setmonofont{}{#2}}
\@onlypreamble\zxjf@multiweight
\def\zxjf@multiweight#1#2#3#4{%
  \zxjf@setmainfont{BoldFont=#2}{#1}%
  \zxjf@setsansfont{BoldFont=#4}{#3}%
  \zxjf@setmonofont{BoldFont=#4}{#3}}

%%%% definitions of mapping
\zxjf@declare@preset{ms}{%
  \zxjf@uniweight{ＭＳ 明朝}{ＭＳ ゴシック}}
\zxjf@declare@preset{ms-dx}{%
  \zxjf@multiweight{ＭＳ明朝}{HG明朝E}{HGｺﾞｼｯｸM}{ＭＳゴシック}}
\zxjf@declare@preset{ipa}{%
  \zxjf@uniweight{IPA明朝}{IPAゴシック}}
\zxjf@declare@preset{ipa-dx}{%
  \zxjf@multiweight{IPA明朝}{HG明朝E}{HGｺﾞｼｯｸM}{IPAゴシック}}
\zxjf@declare@preset{kozuka}{%
  \zxjf@setmainfont{RawFeature=-palt,BoldFont=Kozuka Gothic Pro-VI}%
  {Kozuka Mincho Pro-VI}%
  \zxjf@setsansfont{RawFeature=-palt}{Kozuka Gothic Pro-VI}%
  \zxjf@setmonofont{RawFeature=-palt}{Kozuka Gothic Pro-VI}}
\zxjf@declare@preset{hiragino}{%
  \zxjf@uniweight{ヒラギノ明朝 Pro W3}{ヒラギノ角ゴ Pro W3}}
\zxjf@declare@preset{hiragino-dx}{%
  \zxjf@multiweight{ヒラギノ明朝 Pro W3}{ヒラギノ明朝 Pro W}%
    {ヒラギノ角ゴ Pro W3}{ヒラギノ角ゴ Pro W6}}

%%%% ... and invokes the specified one!
\@nameuse{zxjf@use@preset@\zxjf@preset}

%%------ all done
\endinput
%% EOF
